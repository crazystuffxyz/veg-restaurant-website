<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Review Management</title>
    <!-- Include Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Optional: Add custom styles if needed, or configure Tailwind */
        .review-card p { margin-bottom: 0.5rem; }
        .review-card p:last-child { margin-bottom: 0; }
        .review-card strong { font-weight: 600; color: #4a5568; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    <div class="container mx-auto max-w-6xl p-4 md:p-8">
        <h1 class="text-3xl font-bold text-green-700 mb-6 border-b pb-3">Admin - Review Management</h1>

        <!-- Message Area -->
        <div id="message" class="hidden p-4 mb-6 rounded-md text-sm"></div>

        <!-- Loading Indicators -->
        <div id="loading-pending" class="hidden my-4 text-gray-600"><p>Loading pending reviews...</p></div>
        <div id="loading-approved" class="hidden my-4 text-gray-600"><p>Loading approved reviews...</p></div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- Pending Reviews Section -->
            <section id="pending-reviews-section" class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-yellow-700 mb-4">Pending Approval</h2>
                <div id="pending-reviews-list">
                    <!-- Pending reviews will be loaded here -->
                    <p class="text-gray-500 italic">No pending reviews found.</p> <!-- Default message -->
                </div>
            </section>

            <!-- Approved Reviews Section -->
            <section id="approved-reviews-section" class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-blue-700 mb-4">Approved Reviews</h2>
                <div id="approved-reviews-list">
                    <!-- Approved reviews will be loaded here -->
                     <p class="text-gray-500 italic">No approved reviews found.</p> <!-- Default message -->
                </div>
            </section>

        </div> <!-- End grid -->
    </div> <!-- End container -->

    <script>
        const pendingListDiv = document.getElementById('pending-reviews-list');
        const approvedListDiv = document.getElementById('approved-reviews-list');
        const messageDiv = document.getElementById('message');
        const loadingPendingDiv = document.getElementById('loading-pending');
        const loadingApprovedDiv = document.getElementById('loading-approved');

        // --- Utility Functions ---
        function showMessage(text, type = 'success') {
            messageDiv.textContent = text;
            // Apply Tailwind classes based on type
            messageDiv.className = `p-4 mb-6 rounded-md text-sm ${
                type === 'success' ? 'bg-green-100 border border-green-300 text-green-800' :
                type === 'error' ? 'bg-red-100 border border-red-300 text-red-800' :
                'bg-blue-100 border border-blue-300 text-blue-800' // Default/info
            }`;
            messageDiv.classList.remove('hidden'); // Make it visible
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageDiv.classList.add('hidden');
                messageDiv.textContent = ''; // Clear text
            }, 5000);
        }

        function createReviewCard(review, isPending) {
            const card = document.createElement('div');
            card.className = 'review-card border border-gray-200 p-4 mb-4 rounded-md bg-gray-50 shadow-sm';
            card.id = `review-${review.id}`; // Unique ID for easy removal

            const stars = '‚≠ê'.repeat(review.stars);
            const submittedDate = new Date(review.createdAt).toLocaleString();
            const approvedDate = review.approvedAt ? new Date(review.approvedAt).toLocaleString() : 'N/A';

            card.innerHTML = `
                <p><strong>ID:</strong> <code class="text-xs bg-gray-200 px-1 rounded">${review.id}</code></p>
                <p><strong>Name:</strong> ${review.name || '<span class="italic text-gray-500">Anonymous</span>'}</p>
                <p><strong>Stars:</strong> <span title="${review.stars} stars">${stars}</span> (${review.stars})</p>
                <p><strong>Text:</strong> ${review.text || '<span class="italic text-gray-500">No text provided</span>'}</p>
                <p><strong>Submitted:</strong> ${submittedDate}</p>
                ${!isPending ? `<p><strong>Approved:</strong> ${approvedDate}</p>` : ''}
                <div class="review-actions mt-3 flex flex-wrap gap-2">
                    ${isPending ? `
                        <button class="approve-btn px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm font-medium transition duration-150 ease-in-out" onclick="approveReview('${review.id}')">Approve</button>
                        <button class="reject-btn px-3 py-1 bg-orange-500 text-white rounded hover:bg-orange-600 text-sm font-medium transition duration-150 ease-in-out" onclick="rejectReview('${review.id}')">Reject</button>
                    ` : `
                        <button class="delete-btn px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm font-medium transition duration-150 ease-in-out" onclick="deleteApprovedReview('${review.id}')">Delete Approved</button>
                    `}
                </div>
            `;
            return card;
        }

        // --- Fetch and Render Functions ---
        async function fetchPendingReviews() {
            loadingPendingDiv.classList.remove('hidden');
            pendingListDiv.innerHTML = ''; // Clear previous or default message
            try {
                const response = await fetch('/admin/api/reviews/pending'); // Auth handled by browser Basic Auth prompt
                if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                const reviews = await response.json();

                if (reviews.length === 0) {
                    pendingListDiv.innerHTML = '<p class="text-gray-500 italic">No reviews currently awaiting approval.</p>';
                } else {
                    reviews.forEach(review => {
                        pendingListDiv.appendChild(createReviewCard(review, true)); // true indicates pending
                    });
                }
            } catch (error) {
                console.error('Error fetching pending reviews:', error);
                showMessage(`Error loading pending reviews: ${error.message}`, 'error');
                pendingListDiv.innerHTML = '<p class="text-red-600">Could not load pending reviews.</p>';
            } finally {
                 loadingPendingDiv.classList.add('hidden');
            }
        }

        async function fetchApprovedReviews() {
            loadingApprovedDiv.classList.remove('hidden');
            approvedListDiv.innerHTML = ''; // Clear previous or default message
            try {
                const response = await fetch('/admin/api/reviews/approved'); // Auth handled by browser Basic Auth prompt
                if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                const reviews = await response.json();

                if (reviews.length === 0) {
                    approvedListDiv.innerHTML = '<p class="text-gray-500 italic">No approved reviews found.</p>';
                } else {
                    reviews.forEach(review => {
                        approvedListDiv.appendChild(createReviewCard(review, false)); // false indicates approved
                    });
                }
            } catch (error) {
                console.error('Error fetching approved reviews:', error);
                showMessage(`Error loading approved reviews: ${error.message}`, 'error');
                approvedListDiv.innerHTML = '<p class="text-red-600">Could not load approved reviews.</p>';
            } finally {
                 loadingApprovedDiv.classList.add('hidden');
            }
        }

        // --- Action Functions ---
        async function approveReview(reviewId) {
            // Disable button temporarily? (Optional)
            try {
                const response = await fetch(`/admin/api/reviews/approve/${reviewId}`, { method: 'POST' });
                if (!response.ok) throw new Error(`Failed to approve. Status: ${response.status}`);
                const result = await response.json();
                showMessage(result.message, 'success');

                // Remove from pending list
                const reviewElement = document.getElementById(`review-${reviewId}`);
                if (reviewElement) reviewElement.remove();

                // Refresh both lists for consistency (simplest approach)
                fetchPendingReviews();
                fetchApprovedReviews();

            } catch (error) {
                console.error('Error approving review:', error);
                showMessage(`Error: ${error.message}`, 'error');
            }
        }

        async function rejectReview(reviewId) {
             if (!confirm('Are you sure you want to REJECT and permanently DELETE this pending review? This cannot be undone.')) {
                return;
            }
            try {
                const response = await fetch(`/admin/api/reviews/reject/${reviewId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error(`Failed to reject. Status: ${response.status}`);
                const result = await response.json();
                showMessage(result.message, 'success');

                // Remove from pending list
                const reviewElement = document.getElementById(`review-${reviewId}`);
                if (reviewElement) reviewElement.remove();

                // Check if list is now empty and update message if needed
                 if (pendingListDiv.children.length === 0) {
                    pendingListDiv.innerHTML = '<p class="text-gray-500 italic">No reviews currently awaiting approval.</p>';
                 }

            } catch (error) {
                console.error('Error rejecting review:', error);
                showMessage(`Error: ${error.message}`, 'error');
            }
        }

        async function deleteApprovedReview(reviewId) {
            if (!confirm('Are you sure you want to permanently DELETE this APPROVED review? It will be removed from the public site. This cannot be undone.')) {
                return;
            }
            try {
                // *** Use the NEW endpoint ***
                const response = await fetch(`/admin/api/reviews/approved/delete/${reviewId}`, { method: 'DELETE' });
                 if (!response.ok) throw new Error(`Failed to delete approved review. Status: ${response.status}`);
                const result = await response.json();
                showMessage(result.message, 'success');

                 // Remove from approved list
                const reviewElement = document.getElementById(`review-${reviewId}`);
                if (reviewElement) reviewElement.remove();

                // Check if list is now empty and update message if needed
                 if (approvedListDiv.children.length === 0) {
                    approvedListDiv.innerHTML = '<p class="text-gray-500 italic">No approved reviews found.</p>';
                 }

            } catch (error) {
                console.error('Error deleting approved review:', error);
                showMessage(`Error: ${error.message}`, 'error');
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Fetch both lists when the page loads
            fetchPendingReviews();
            fetchApprovedReviews();
        });

    </script>
</body>
</html>
