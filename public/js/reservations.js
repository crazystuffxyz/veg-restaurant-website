$(document).ready((function(){const e=moment().format("YYYY-MM-DD"),t=moment().add(3,"months"),a=t.format("YYYY-MM-DD"),l=t.add(1,"day").format("YYYY-MM-DD"),o=$("#date"),s=$("#numberOfPeople"),i=$("#time"),n=$("#time-loader"),r=$("#reservationForm"),d=$("#reservationMessage"),c=$("#submitButton"),h=$("#buttonText"),g=$("#buttonSpinner"),p="(703) 319-2700";let m=o.val()||e;function u(e){console.log(`[applyCalendarHighlight] Called with dateStr: '${e||"null/undefined"}'`);const t=$(".fc-day");if(t.hasClass("fc-day-selected-highlight")?(console.log(`[applyCalendarHighlight] Removing 'fc-day-selected-highlight' from ${t.length} elements.`),t.removeClass("fc-day-selected-highlight")):console.log("[applyCalendarHighlight] No existing highlights found to remove."),e){const t=`.fc-day[data-date="${e}"]`;console.log(`[applyCalendarHighlight] Attempting to highlight cell with selector: "${t}"`),setTimeout((()=>{const e=$(t);e.length>0?e.hasClass("fc-day-selected-highlight")?console.log("[applyCalendarHighlight] Element already has highlight class:",e[0]):(console.log("[applyCalendarHighlight] Adding 'fc-day-selected-highlight' to element:",e[0]),e.addClass("fc-day-selected-highlight")):console.warn(`[applyCalendarHighlight] Could not find element with selector "${t}" to highlight.`)}),0)}else console.log("[applyCalendarHighlight] dateStr is null or empty, only clearing highlights (done above).")}function v(e,t){console.log(`[fetchAvailableTimes] Date: ${e}, Party: ${t}`),i.html('<option value="" disabled selected>Select date & guests first</option>').prop("disabled",!0),d.html(""),e&&t&&(n.removeClass("hidden").addClass("flex"),i.prop("disabled",!0),fetch(`/availability?date=${e}&partySize=${t}`).then((e=>(n.addClass("hidden").removeClass("flex"),e.ok?e.json():e.json().then((t=>{throw new Error(t.error||`Server error: ${e.status}`)})).catch((()=>{throw new Error(`Network response was not ok: ${e.status}`)}))))).then((a=>{!function(e,t,a){console.log(`[populateTimeSlots] Populating for ${a}`),i.empty();let l=!1;const o=moment();if(!e||0===e.length)return i.append('<option value="" disabled selected>No times available</option>'),d.html(`<span class="text-secondary-light text-sm">Sorry, no online reservations are available for ${t} guest(s) on this date. Please try another date or call us at <a href="tel:${p}" class="underline hover:text-primary">${p}</a>.</span>`),void i.prop("disabled",!0);i.append('<option value="" disabled selected>Select an available time</option>'),e.forEach((e=>{const t=$("<option></option>");t.val(e.time);let s=e.displayTime,n=!1,r=!1;if(moment(a+" "+e.time,"YYYY-MM-DD HH:mm").isBefore(o)&&(r=!0,n=!0,s+=" (Past)",t.addClass("unavailable")),!r){const a=e.status||"available",o=e.availableSeats;switch(a){case"available":l=!0;break;case"limited":l=!0,o&&(s+=` (Only ${o} seat${o>1?"s":""} left)`);break;case"full":s+=" (Booked)",n=!0,t.addClass("unavailable");break;default:s+=" (Unavailable)",n=!0,t.addClass("unavailable")}}t.text(s),t.prop("disabled",n),i.append(t)})),l?i.prop("disabled",!1):(e.length>0&&(i.find("option:not([disabled])").remove(),i.prepend('<option value="" disabled selected>No suitable times available</option>'),d.html(`<span class="text-secondary-light text-sm">Sorry, we don't have availability for ${t} guest(s) at any time on this date. Please try another date or call us at <a href="tel:${p}" class="underline hover:text-primary">${p}</a>.</span>`)),i.prop("disabled",!0))}(a.slots,t,e)})).catch((e=>{console.error("Error fetching times:",e),i.empty().append('<option value="" disabled selected>Error loading times</option>').prop("disabled",!0),d.html(`<span class="text-red-400 text-sm">Could not load times: ${e.message}. Please try again or call us.</span>`)})))}$("#calendar").fullCalendar({header:{left:"prev",center:"title",right:"next"},defaultDate:e,navLinks:!1,editable:!1,eventLimit:!0,selectable:!0,selectHelper:!0,validRange:{start:e,end:l},dayRender:function(t,a){const l=t.format("YYYY-MM-DD");a.attr("data-date",l),l<e&&a.addClass("fc-past"),l===m&&(a.hasClass("fc-day-selected-highlight")||(console.log(`[dayRender] Adding initial highlight to ${l}`),a.addClass("fc-day-selected-highlight")))},dayClick:function(e,t,a){const l=e.format("YYYY-MM-DD");l<moment().format("YYYY-MM-DD")||(console.log(`[dayClick] Clicked on: ${l}`),m=l,u(l),o.val(l),o.trigger("change",["calendarClick"]))},viewRender:function(e,t){console.log(`[viewRender] View changed. Applying highlight based on state: '${m}'`),u(m)}}),o.attr("min",e),o.attr("max",a),o.val(e),m=e,o.add(s).on("change",(function(e,t){const a=o.val(),l=s.val(),i=$(e.target);moment().format("YYYY-MM-DD");if(console.log("--- Change Event Start ---"),console.log(`Source: ${t||"Input/Select Change"}`),console.log(`Target Element ID: ${i.attr("id")}`),console.log(`Selected Date: ${a}`),console.log(`Party Size: ${l}`),console.log(`Current highlightedDate State before update: ${m}`),"calendarClick"!==t&&(m=a||null,console.log(`Updated highlightedDate State to: ${m}`)),"calendarClick"!==t&&i.is(o))if(a){console.log(`Input Change: Navigating calendar view using gotoDate(${a})...`);try{$("#calendar").fullCalendar("gotoDate",a),u(m)}catch(e){console.error("Error during gotoDate execution:",e)}}else console.log("Input Change: Date input cleared, removing visual highlight."),u(null);else a?(console.log("Party/Calendar Change: Applying highlight based on state:",m),u(m)):(console.log("Change Event: Date is empty, ensuring highlight is cleared."),u(null));v(a,l),console.log("--- Change Event End ---")})),r.submit((function(e){e.preventDefault();let t=!0;if($(".text-red-400.text-xs").text(""),d.html(""),$("#name").val()||($("#name-error").text("Name is required."),t=!1),$("#email").val()&&/^\S+@\S+\.\S+$/.test($("#email").val())||($("#email-error").text("Valid email is required."),t=!1),s.val()||($("#people-error").text("Party size is required."),t=!1),o.val()||($("#date-error").text("Date is required."),t=!1),i.val()&&!i.find("option:selected").prop("disabled")||($("#time-error").text("Please select an available time slot."),t=!1),!t)return d.html('<span class="text-red-400 text-sm">Please correct the errors above.</span>'),void $(".text-red-400.text-xs").not(":empty").first().closest("div").find("input, select, textarea").first().focus();d.html(""),h.text("Sending Request..."),g.removeClass("hidden"),c.prop("disabled",!0).addClass("opacity-75 cursor-not-allowed");const a={name:$("#name").val(),email:$("#email").val(),numberOfPeople:s.val(),date:o.val(),time:i.val(),specialRequests:$("#specialRequests").val()||""};fetch("/reserve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).then((e=>e.ok?e.json():e.json().catch((()=>{throw new Error(`Server responded with status: ${e.status}`)})).then((e=>{throw e})))).then((e=>{d.html(`<div class="p-4 bg-green-600/20 border border-green-500 rounded-lg text-green-300 text-sm"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline -mt-1 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>${e.message||"Request sent! Please check your email to verify."}</div>`),r[0].reset(),i.html('<option value="" disabled selected>Select date & guests first</option>').prop("disabled",!0),o.val(""),s.val(""),m=null,u(null),$(".text-red-400.text-xs").text(""),d.append('<div class="mt-2 text-xs text-neutral-light/70">Form reset. Select details for a new reservation.</div>'),setTimeout((()=>{h.text("Request Reservation"),g.addClass("hidden"),c.prop("disabled",!1).removeClass("opacity-75 cursor-not-allowed")}),1500)})).catch((e=>{console.error("Error during fetch:",e);let t="An unexpected error occurred. Please try again.";e&&e.error?t=e.error:e&&e.message?t=e.message:"string"==typeof e&&(t=e),d.html(`<div class="p-4 bg-red-600/20 border border-red-500 rounded-lg text-red-300 text-sm"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline -mt-1 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>Reservation failed: ${t}</div>`),h.text("Request Reservation"),g.addClass("hidden"),c.prop("disabled",!1).removeClass("opacity-75 cursor-not-allowed")}))})),console.log("[Initial Setup] Applying initial highlight based on state:",m),u(m),setTimeout((()=>{console.log("--- Triggering Initial Change ---"),o.trigger("change")}),100)}));